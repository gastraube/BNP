@model BNP.Web.Models.MovimentoManualViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Movimentos Manuais";
}

<h2>Movimentos Manuais (@Model.Mes/@Model.Ano)</h2>

@using (Html.BeginForm("Create", "MovimentoManual", FormMethod.Post, new { id = "formMovimento" }))
{
    @Html.AntiForgeryToken()

    <fieldset id="formCampos" disabled>
        <div class="form-row">
            <div class="form-group col-md-6">
                @Html.LabelFor(m => m.Mes)
                @Html.TextBoxFor(m => m.Mes, new { @class = "form-control", type = "number" })
            </div>
            <div class="form-group col-md-6">
                @Html.LabelFor(m => m.Ano)
                @Html.TextBoxFor(m => m.Ano, new { @class = "form-control", type = "number" })
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                @Html.Label("Produto")
                @Html.DropDownListFor(m => m.CodigoProduto, Model.Produtos, "-- selecione --", new { @class = "form-control", id = "ddlProduto" })
            </div>
            <div class="form-group col-md-6">
                @Html.Label("Cosif")
                @Html.DropDownList("CodigoCosif", Enumerable.Empty<SelectListItem>(), "-- selecione --", new { @class = "form-control", id = "ddlCosif" })
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-4">
                @Html.LabelFor(m => m.Valor)
                @Html.TextBoxFor(m => m.Valor, new { @class = "form-control", type = "number", step = "0.01" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Descricao)
            @Html.TextBoxFor(m => m.Descricao, new { @class = "form-control" })
        </div>
    </fieldset>

    <div class="form-group mt-3">
        <button type="button" id="btnLimpar" class="btn btn-warning d-none">Limpar</button>
        <button type="button" id="btnNovo" class="btn btn-primary">Novo</button>
        <button type="submit" id="btnSalvar" class="btn btn-success d-none">Incluir</button>
        <button type="button" id="btnCancelar" class="btn btn-secondary d-none">Cancelar</button>
    </div>
}

<hr />

@if (Model.Grid != null)
{
    <table class="table table-bordered table-striped mt-4">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Produto</th>
                <th>COSIF</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Data</th>
                <th>Usuário</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Grid)
            {
                <tr>
                    <td>@item.NumeroLancamento</td>
                    <td>@item.CodigoProduto</td>
                    <td>@item.CodigoCosif</td>
                    <td>@item.Descricao</td>
                    <td>@item.Valor</td>
                    <td>@item.DataMovimento</td>
                    <td>@item.Usuario</td>
                </tr>
            }
        </tbody>
    </table>
}

@section scripts {
    <script>
        $(function () {
            $('#btnNovo').click(function () {
                $('#formCampos').removeAttr('disabled');
                $('#btnSalvar, #btnCancelar, #btnLimpar').removeClass('d-none');
                $('#btnNovo').addClass('d-none');
            });

            $('#btnCancelar').click(function () {
                $('#formMovimento')[0].reset();
                $('#formCampos').attr('disabled', 'disabled');
                $('#btnSalvar, #btnCancelar, #btnLimpar').addClass('d-none');
                $('#btnNovo').removeClass('d-none');
                $('#ddlCosif').empty().append($('<option>').val('').text('-- selecione --'));
            });

            $('#btnLimpar').click(function () {
                $('#formMovimento')[0].reset();
                $('#ddlCosif').empty().append($('<option>').val('').text('-- selecione --'));
            });

           $('#ddlProduto').change(function () {
                var codProduto = $(this).val();
                console.log("Produto selecionado: " + codProduto);

                var $cosif = $('#ddlCosif');
                $cosif.empty().append($('<option>').val('').text('-- selecione --'));

                if (codProduto) {
                    var url = '@Url.Action("CosifsPorProduto", "MovimentoManual")';
                    console.log("Chamando endpoint: " + url);

                    $.getJSON(url, { codProduto: codProduto }, function (data) {
                        console.log("Resposta do endpoint:", data);
                        $.each(data, function (_, item) {
                            $cosif.append($('<option>').val(item.value).text(item.text));
                        });
                    });
                }
            });
        });
    </script>
}
